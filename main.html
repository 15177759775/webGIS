<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Team5 HomePage</title>

    <link rel="stylesheet" type="text/css" href="style.css">
    <script src="script.js" type="text/javascript"></script>
    <script src="jquery-3.6.4.min.js" type="text/javascript"></script>

    <link href="ol/ol.css" rel="stylesheet" type="text/css" />
    <script src="Scripts/ol.js" type="text/javascript"></script>

    <script src="layui\layui.js" type="text/javascript"></script>
    <link rel="stylesheet" href="layui/css/layui.css">
</head>


<body>
    <script>
        layui.use(['layer', 'form'], function () {
            var layer = layui.layer
                , form = layui.form;

            layer.msg('Welcome!');
        });
    </script>

    <input type="text" id="name" />
    <input type="text" id="sex" /><br>
    <div id="map" style="width: 100%;height:92vh;"></div>
    <div id="scale-line"></div>
    <div id="rotate"></div>
    <div id="overviewMap"></div>
    <div id="legend"></div>
    <!-- <div id="popup" class="ol-popup">
        <a href="#" id="popup-closer" class="ol-popup-closer"></a>
        <div id="popup-content"></div>
    </div> -->
    <div id="image-container">
        <div class="image" id="terrain">
            <img src="img/terrain.png" alt="terrain">
        </div>
        <div class="image" id="image">
            <img src="img/image.png" alt="image">
        </div>
        <div class="image" id="vector">
            <img src="img/vector.png" alt="vector">
        </div>
        <div>
            <div class="mode_change_button"><button id="wms_mode" class="mode_button">WMS Mode</button></div>
            <div class="mode_change_button"><button id="json_mode" class="mode_button">JSON Mode</button></div>
        </div>
    </div>
    <div class="circle"></div>
    <div id="legend2" class="table-legend" style="position: absolute;
	top: 60px;
	right: 10px;
	border: 3px solid darkorange;">
        <table>
            <tr>
                <td><span class="circle red"></span> 徐欣蕾</td>
                <td><span class="circle yellow"></span> 胡培焘</td>
            </tr>
            <tr>
                <td><span class="circle blue"></span> 张扬</td>
                <td><span class="circle green"></span> 方浩</td>
            </tr>
        </table>
    </div>

    <script type="text/javascript">


        var name = getURLParameter('name');
        var sex = getURLParameter('sex');

        window.onload = function () {
            $("#name").val(name);
            $("#sex").val(sex);
        }

        var format = 'image/png';
        var bounds = [143.83482400000003, -43.648056,
            148.47914100000003, -39.573891];
        var projection = new ol.proj.Projection({
            code: 'EPSG:4326',
            units: 'degrees',
            axisOrientation: 'neu',
            global: true
        });

        // http://localhost:8084/geoserver/wms?bbox=-130,24,-66,50&styles=population&Format=image/png&request=GetMap&layers=topp:states&width=550&height=250&srs=EPSG:4326
        // http://localhost:8084/geoserver/wms?service=WMS&version=1.1.0&request=GetMap&layers=tasmania&bbox=143.83482400000003%2C-43.648056%2C148.47914100000003%2C-39.573891&width=768&height=673&srs=EPSG%3A4326&format=application/openlayers
        var key = 'a8d7c92a48a8fab75e06a1e3bbfe59ef';
        key = 'cb9cbd9a91812d57ccef5cd25ebf7d5b';
        var tianditu_layer1 = new ol.layer.Tile({
            source: new ol.source.XYZ({
                url: 'http://t0.tianditu.gov.cn/DataServer?T=img_w&x={x}&y={y}&l={z}&tk=' + key
            })
        });
        var tianditu_layer2 = new ol.layer.Tile({
            source: new ol.source.XYZ({
                url: 'http://t0.tianditu.gov.cn/DataServer?T=vec_w&x={x}&y={y}&l={z}&tk=' + key
            })
        });
        var tianditu_layer3 = new ol.layer.Tile({
            source: new ol.source.XYZ({
                url: 'http://t0.tianditu.gov.cn/DataServer?T=cva_w&x={x}&y={y}&l={z}&tk=' + key
            })
        });
        var wmsSource = new ol.source.TileWMS({
            url: 'http://114.132.63.66:8084/geoserver/wms',
            params: {
                'FORMAT': format,
                'VERSION': '1.1.1',
                tiled: true,
                "LAYERS": 'track_layer',
                //"exceptions": 'application/vnd.ogc.se_inimage',
                tilesOrigin: 143.83482400000003 + "," + -43.648056
            }
        });
        var wmsSource = new ol.source.TileWMS({
            url: 'http://114.132.63.66:8084/geoserver/wms',
            params: {
                'FORMAT': format,
                'VERSION': '1.1.1',
                tiled: true,
                "LAYERS": 'track_layer',
                //"exceptions": 'application/vnd.ogc.se_inimage',
                tilesOrigin: 143.83482400000003 + "," + -43.648056
            }
        });
        var tiled = new ol.layer.Tile({
            // visible: false,
            source: wmsSource,
            projection: 'EPSG:3857'
        });
        // https://blog.csdn.net/long_Amber/article/details/110553202
        var map = new ol.Map({
            target: 'map',
            layers: [
                tianditu_layer1,
                tianditu_layer2,
                tianditu_layer3,
                tiled
            ],
            view: new ol.View({
                center: [12730008, 3571714],
                zoom: 10,
                projection: 'EPSG:3857'
            }),
            controls: ol.control.defaults().extend([    // 往地图增加控件
                new ol.control.ZoomSlider(), //滑块控件
                new ol.control.ZoomToExtent({  //特定位置控件
                    extent: [
                        12704572, 3561551,//矩形左上角坐标
                        12750396, 3586508 //矩形右下角坐标
                    ],

                }),
                new ol.control.FullScreen(), //全屏控件
                new ol.control.MousePosition({
                    coordinateFormat: coordinateFormat,
                    projection: 'EPSG:4326', // 地理坐标系
                }),//坐标拾取控件1
                new ol.control.OverviewMap({
                    collasped: false,
                    target: "overviewMap"
                }), //鹰眼控件
                new ol.control.ScaleLine({}), //比例尺控件
                new ol.control.Rotate({
                    autoHide: false,
                    target: "rotate",
                }),
            ]),
        });



        // map.addLayer(tiled);
        // map.addLayer(sky_map_layer);
        // map.getView().fit(bounds, map.getSize());
        var layer2Button = document.getElementById('terrain');
        var layer1Button = document.getElementById('image');
        var layer3Button = document.getElementById('vector');



        // initialize
        var border_style = "3px solid orange"
        tianditu_layer1.setVisible(false);
        layer1Button.style.border = "none";

        layer1Button.onclick = function () {
            tianditu_layer1.setVisible(true);
            tianditu_layer2.setVisible(false);
            layer2Button.style.border = "none";
            layer1Button.style.border = border_style;
        };

        layer2Button.onclick = function () {
            tianditu_layer2.setVisible(true);
            tianditu_layer1.setVisible(false);
            layer1Button.style.border = "none";
            layer2Button.style.border = border_style;
        };
        layer3Button.onclick = function () {
            tianditu_layer3.setVisible(!tianditu_layer3.getVisible());
            if (tianditu_layer3.getVisible()) {
                layer3Button.style.border = border_style;
            } else {
                layer3Button.style.border = "none";
            }

        };

        // Legend
        var legendImg = new Image();
        legendImg.src = 'http://114.132.63.66:8084/geoserver/wms?REQUEST=GetLegendGraphic&VERSION=1.0.0&FORMAT=image/png&WIDTH=30&HEIGHT=20&LAYER=track_layer';
        var legendDiv = document.getElementById('legend');
        legendDiv.appendChild(legendImg);

        // Pop Up
        var vectorSource = new ol.source.Vector({
            format: new ol.format.GeoJSON(),
            url: function (extent) {
                return 'http://114.132.63.66:8084/geoserver/wfs?service=WFS&' +
                    'version=1.1.1&request=GetFeature&typename=track_layer&' +
                    'outputFormat=application/json&srsname=EPSG:3857&' +
                    'bbox=' + extent.join(',') + ',EPSG:3857';
            },
            strategy: ol.loadingstrategy.bbox
        });

        var vectorLayer = new ol.layer.Vector({
            source: vectorSource
        });

        map.addLayer(vectorLayer);
        map.on('singleclick', function (evt) {
            console.log("b");
            var feature = map.forEachFeatureAtPixel(evt.pixel,
                function (feature, layer) {
                    return feature;
                });
            if (feature) {
                console.log("a");
                var properties = feature.getProperties();
                var content = '<table class="table table-bordered">';
                for (var key in properties) {
                    content += '<tr><th>' + key + '</th><td>' + properties[key] + '</td></tr>';
                }
                content += '</table>';
                $(popup.getElement()).popover({
                    'placement': 'top',
                    'html': true,
                    'content': content
                });
                popup.setPosition(evt.coordinate);
                $(popup.getElement()).popover('show');
            }
        });
        // // 创建一个Vector图层对象
        // var vectorLayer = new ol.layer.Vector({
        //     source: new ol.source.Vector({
        //         url: 'http://114.132.63.66:8080/webgis/tracing/data/足迹数据.geojson.txt', // geoJSON文件的路径
        //         format: new ol.format.GeoJSON() // 解析geoJSON数据的格式类
        //     })
        // });

        // // 将Vector图层添加到地图中
        // map.addLayer(vectorLayer);
        // 创建一个Vector图层对象
        var vectorLayer = new ol.layer.Vector({
            source: new ol.source.Vector({
                url: 'http://114.132.63.66:8080/webgis/tracing/data/足迹数据.geojson.txt',
                format: new ol.format.GeoJSON()
            })
        });


        // 按属性“人”配置点状geojson数据的样式
        var styleFunction = function (feature) {
            var person = feature.get('人');
            var color = 'white';
            if (person == '徐欣蕾') {
                color = 'red';
            } else if (person == '胡培焘') {
                color = 'yellow';
            } else if (person == '张扬') {
                color = 'blue';
            } else if (person == '方浩') {
                color = 'green';
            }
            console.log(color);
            return new ol.style.Style({
                image: new ol.style.Circle({
                    radius: 5,
                    fill: new ol.style.Fill({ color: color })
                })
            });
        };

        // 设置Vector图层的样式函数
        vectorLayer.setStyle(styleFunction);
        map.addLayer(vectorLayer);


        // Switch between WMS and JSON
        var wms_mode = document.getElementById("wms_mode");
        var json_mode = document.getElementById("json_mode");
        var legend2 = document.getElementById("legend2");
        wms_mode.onclick = function(){
            tiled.setVisible(true);
            vectorLayer.setVisible(false);
            legendDiv.hidden = false;
            legend2.hidden = true;
        };
        json_mode.onclick = function(){
            tiled.setVisible(false);
            vectorLayer.setVisible(true);

            legendDiv.hidden = true;
            legend2.hidden = false;
        };
        wms_mode.onclick();
    </script>
</body>


</html>